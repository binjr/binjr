trigger:
  branches:
    include:
      - master
      - '*-dev'
      - '*-ci_test'
  tags:
    include:
      - v*

name: $(Date:yyyyMMdd)$(Rev:.r)

variables:
  system.debug: false
  isTag: 'false'
  isSnapshot: 'false'
  javaVersion: '20'

stages:
  - stage: build
    jobs:
      # Linux app bundle job
      - template: build-job.yml
        parameters:
          name: app_bundle_linux
          platform: linux
          jdkDownloadUrl: https://api.adoptium.net/v3/binary/latest/$(javaVersion)/ga/linux/x64/jdk/hotspot/normal/eclipse
          jdkFile:  $(Agent.TempDirectory)/jdk-latest-linux_x64.tar.gz
          javaVersion: $(javaVersion)
          pool:
            vmImage: 'ubuntu-18.04'

      # MacOS app bundle job
      - template: build-job.yml
        parameters:
          name: app_bundle_mac
          platform: mac
          jdkDownloadUrl: https://api.adoptium.net/v3/installer/latest/$(javaVersion)/ga/mac/x64/jdk/hotspot/normal/eclipse
          jdkFile: $(Agent.TempDirectory)/jdk-latest-macosx_x64.pkg
          javaVersion: $(javaVersion)
          pool:
            vmImage: 'macOS-11'

      # Windows app bundle job
      - template: build-job.yml
        parameters:
          name: app_bundle_windows
          platform: win
          jdkDownloadUrl: https://api.adoptium.net/v3/binary/latest/$(javaVersion)/ga/windows/x64/jdk/hotspot/normal/eclipse
          jdkFile: $(Agent.TempDirectory)/jdk-latest-win_x64.zip
          javaVersion: $(javaVersion)
          pool:
            vmImage: 'windows-2022'

      # Finalize release
  - stage: deploy_site
    dependsOn: build
    condition: and(succeeded(), startsWith(variables['Build.SourceBranch'], 'refs/tags/'), not(endsWith(variables['Build.SourceBranch'], '-SNAPSHOT')), not(contains(variables['Build.SourceBranch'], '-b')))
    jobs:
    - job: deploy_site
      pool:
        vmImage: 'ubuntu-20.04'
      steps:
        - script: |
            curl --output $(Agent.TempDirectory)/jdk-latest-linux_x64.tar.gz -O -J -L https://api.adoptium.net/v3/binary/latest/$(javaVersion)/ga/linux/x64/jdk/hotspot/normal/eclipse

        - task: JavaToolInstaller@0
          inputs:
            versionSpec: $(javaVersion)
            jdkArchitectureOption: x64
            jdkSourceOption: LocalDirectory
            jdkFile: $(Agent.TempDirectory)/jdk-latest-linux_x64.tar.gz
            jdkDestinationDirectory: $(Agent.ToolsDirectory)/binaries/openjdk
            cleanDestinationDirectory: true

        - task: DownloadSecureFile@1
          name: gpgKeyring
          displayName: 'Download GPG Keyring'
          inputs:
            secureFile: 'keyring.gpg'

        - task: Gradle@2
          env:
            IS_TAG: 'true'
            REPO_TAG_NAME: $(Build.SourceBranchName)
            GPG_KEY_NAME: $(gpg.keyname)
            GPG_PASSPHRASE: $(gpg.passphrase)
            GPG_KEYRING_PATH: $(gpgKeyring.secureFilePath)
            OSSRH_TOKEN_PASSWORD: $(ossrh.token.password)
            OSSRH_TOKEN_USERNAME: $(ossrh.token.username)
          inputs:
            gradleWrapperFile: 'gradlew'
            javaHomeOption: 'JDKVersion'
            jdkVersionOption: 1.$(javaVersion)
            jdkArchitectureOption: 'x64'
            publishJUnitResults: false
            tasks: 'expandMdTemplates'

        - bash: |
            python3 --version
            python3 -m pip --version
            python3 -m pip install --upgrade pip setuptools
            python3 -m pip install mkdocs
            python3 -m pip install mkdocs-material
            git clone -b sources https://github.com/binjr/binjr.github.io build/tmp/binjr-site
            cd  build/tmp/binjr-site
            cp ../expanded/CHANGELOG.md docs/download/CHANGELOG.md
            cp ../expanded/latest_release.md docs/download/latest_release.md
            git config credential.helper store
            echo "https://binjr-bot:$GH_ACCESS_TOKEN@github.com" >> "$HOME/.git-credentials"
            git config user.email "binjr.bot@free.fr"
            git config user.name "binjr-bot"
            wget https://api.github.com/repos/binjr/binjr/releases/latest -O docs/repos/binjr/binjr/releases/latest
            git commit -am "Release  $BUILD_SOURCEBRANCHNAME"
            git push
            python3 -m mkdocs gh-deploy --remote-branch master
          env:
            GH_ACCESS_TOKEN: $(gh.access.token)

  - stage: maven_publish
    dependsOn: build
    jobs:
    # Publish to Maven repo
    - job: maven_publish
      pool:
        vmImage: 'ubuntu-20.04'
      steps:
        - script: |
            echo '##vso[task.setvariable variable=isTag;]true'
          condition: and(succeeded(), startsWith(variables['Build.SourceBranch'], 'refs/tags/'))

        - script: |
            curl --output $(Agent.TempDirectory)/jdk-latest-linux_x64.tar.gz -O -J -L https://api.adoptium.net/v3/binary/latest/$(javaVersion)/ga/linux/x64/jdk/hotspot/normal/eclipse

        - task: JavaToolInstaller@0
          inputs:
            versionSpec: $(javaVersion)
            jdkArchitectureOption: x64
            jdkSourceOption: LocalDirectory
            jdkFile: $(Agent.TempDirectory)/jdk-latest-linux_x64.tar.gz
            jdkDestinationDirectory: $(Agent.ToolsDirectory)/binaries/openjdk
            cleanDestinationDirectory: true

        - task: DownloadSecureFile@1
          name: gpgKeyring
          displayName: 'Download GPG Keyring'
          inputs:
            secureFile: 'keyring.gpg'

        - task: Gradle@2
          env:
            IS_TAG: $(isTag)
            REPO_TAG_NAME: $(Build.SourceBranchName)
            BINJR_BUILD_NUMBER: $(Build.BuildNumber)
            GPG_KEY_NAME: $(gpg.package.keyname)
            GPG_PASSPHRASE: $(gpg.package.passphrase)
            GPG_KEYRING_PATH: $(gpgKeyring.secureFilePath)
            OSSRH_TOKEN_PASSWORD: $(ossrh.token.password)
            OSSRH_TOKEN_USERNAME: $(ossrh.token.username)
          inputs:
            gradleWrapperFile: 'gradlew'
            javaHomeOption: 'JDKVersion'
            jdkVersionOption: 1.$(javaVersion)
            jdkArchitectureOption: 'x64'
            publishJUnitResults: false
            tasks: 'publishArtifacts'